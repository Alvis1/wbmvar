<head>

  <title>Attention </title>
<!--A-Frame-->
  <script src="https://aframe.io/releases/1.7.0/aframe.min.js"></script>
<!--A-Frame Extras-->
  <script src="https://cdn.jsdelivr.net/gh/c-frame/aframe-extras@7.6.1/dist/aframe-extras.min.js"></script>
<!--Environment-->
  <script src="https://unpkg.com/aframe-environment-component@1.3.3/dist/aframe-environment-component.min.js"></script>
<!--Event-Set Component-->
  <script src="https://unpkg.com/aframe-event-set-component@5/dist/aframe-event-set-component.min.js"></script>
<!--Shooting-Script--> 
  <script src="aframe-super-shooter-kit.min.js"></script>


<script>
AFRAME.registerComponent('click-to-shoot', {
  init: function () {
    document.body.addEventListener('mousedown', () => {
    this.el.emit('shoot');
    });
  }
});

// Change color when hit + die + respawn
AFRAME.registerComponent('hit-handler', {
  schema: {
    points: { type: 'int', default: 1 },
    respawn: { type: 'boolean', default: true },
    respawnDelay: { type: 'int', default: 10000 }
  },
  dependencies: ['material'],

  init: function () {
    const el = this.el;
    const color = new THREE.Color();
    let dead = false;
    let active = false;
    let gameRunning = false; // authoritative flag

    // Start inactive
    el.setAttribute('visible', false);
    el.classList.remove('enemy');

    // Game start
    el.sceneEl.addEventListener('game-start', () => {
      gameRunning = true;
      active = true;
      dead = false;

      el.setAttribute('visible', true);
      el.classList.add('enemy');
      el.play();
    });

    // Game end
    el.sceneEl.addEventListener('game-end', () => {
      gameRunning = false;
      active = false;
      dead = false;

      el.setAttribute('visible', false);
      el.classList.remove('enemy');
      el.pause();
    });

    // Hit
    el.addEventListener('hit', () => {
      if (!gameRunning || !active || dead) return;
      color.addScalar(0.05);
      el.components.material.material.color.copy(color);
    });

    // Die
    el.addEventListener('die', () => {
      if (!gameRunning || !active || dead) return;
      dead = true;

      el.sceneEl.emit('score', { points: this.data.points });

      el.setAttribute('visible', false);
      el.classList.remove('enemy');
      el.pause();

      // Conditional respawn
      if (!this.data.respawn) return;

      setTimeout(() => {
        // Abort if game is no longer running
        if (!gameRunning) return;

        dead = false;
        el.setAttribute('visible', true);
        el.classList.add('enemy');
        el.play();
      }, this.data.respawnDelay);
    });
  }
});



// Score system
AFRAME.registerComponent('score-keeper', {
  init: function () {
    this.score = 0;
    this.el.setAttribute('text', 'value', '0');

    this.el.sceneEl.addEventListener('game-start', () => {
    this.score = 0;
    this.el.setAttribute('text', 'value', '0');
    });

    this.el.sceneEl.addEventListener('score', (evt) => {
      const points = evt.detail?.points ?? 1; // default +1
      this.score += points;
      this.el.setAttribute('text', 'value', `${this.score}`);
    });
  }
});


// Start Game Target
AFRAME.registerComponent('start-game-target', {
  init: function () {
    const el = this.el;
    let active = true;

    el.classList.add('enemy');

    el.addEventListener('die', () => {
      if (!active) return;
      active = false;

      el.sceneEl.emit('game-start');

      el.setAttribute('visible', false);
      el.classList.remove('enemy');
      el.pause();
    });

    // Reappear after game ends
    el.sceneEl.addEventListener('game-end', () => {
      active = true;
      el.setAttribute('visible', true);
      el.classList.add('enemy');
      el.play();
    });
  }
});


//Game timer
AFRAME.registerComponent('game-timer', {
  schema: {
    duration: { type: 'int', default: 60 } // seconds
  },

  init: function () {
    this.timeout = null;

    this.el.sceneEl.addEventListener('game-start', () => {
      // Clear previous timer if any
      if (this.timeout) clearTimeout(this.timeout);

      // Start countdown
      this.timeout = setTimeout(() => {
        this.el.sceneEl.emit('game-end');
      }, this.data.duration * 1000);
    });
  }
});

</script>






</head>

<!--Mixins-->

<!--Assets-->
  <a-entity id="bulletTemplate" bullet geometry="primitive: sphere; radius: 1" material="color: orange"></a-entity>

  <a-asset>
        <a-asset-item id="SkyBall" src="Objects/SkyBall.glb"></a-asset-item>
        <a-asset-item id="Ship" src="Objects/SpaceShip.glb"></a-asset-item>
        <a-asset-item id="Bull" src="Objects/BulletModel.glb" scale="5 5 5"></a-asset-item>
  </a-asset>

<!--World-->
<body>
  <a-scene game-timer="duration: 10" environment="preset: tron; ground: noise; groundTexture: none; dressing: none" fog="color: #940000; far: 84">

<!--Score-Text-->
<a-entity
  position="12.250 4 -40"
  scale="10 10 10"
  text="color: #787878; width: 20; value: align: center; tabSize: 4; alphaTest: 0.5; align: center"
  score-keeper>
</a-entity>
<a-entity
  position="-7.5 4 -40"
  scale="10 10 10"
  text="color: #787878; width: 20; value: SCORE; tabSize: 4; alphaTest: 0.5; align: center">
</a-entity>


<!--<a-entity position="0 0.99938 0" text="color: white; value: Get in loser. We're going shooting.; width: 1.5"></a-entity>-->

  <a-entity id="bulletTemplate" bullet gltf-model="#Bull" material="color: orange"></a-entity>

  <a-entity id="startTarget" target="" geometry="primitive: octahedron" material="emissive: #00ff00; emissiveIntensity: 0.75" position="0 1.5 -8" scale="2 2 2" start-game-target></a-entity>

  <a-entity class="enemy" target="" geometry="primitive: octahedron" material="emissive: #00ffff; emissiveIntensity: 0.75" position="0 1.5 -4" hit-handler="points: 1; respawn: false"></a-entity>
  <a-entity class="enemy" target="" geometry="primitive: octahedron" material="emissive: #00ffff; emissiveIntensity: 0.75" position="2 3.5 -4" hit-handler="points: 1; respawn: false"></a-entity>
  <a-entity class="enemy"  target="" geometry="primitive: octahedron" material="emissive: #00ffff; emissiveIntensity: 0.75" position="-2 3.5 -4" hit-handler="points: 1; respawn: false"></a-entity>
  <a-entity class="enemy bad" target="" geometry="primitive: octahedron" material="emissive: #ff0000; emissiveIntensity: 0.75" position="4 1.5 -4" hit-handler="points: -1; respawn: true; respawnDelay: 2000"></a-entity>
  <a-entity class="enemy bad" target="" geometry="primitive: octahedron" material="emissive: #ff0000; emissiveIntensity: 0.75" position="-4 1.5 -4" hit-handler="points: -1; respawn: true; respawnDelay: 2000"></a-entity>

<!--Camera-Ship-Gun-->
    <a-camera id="camera" id="head" look-controls wasd-controls="acceleration: 10; wsAxis: y; wsInverted: true" position="0 1 2">
      <a-entity gltf-model="#Ship" obb-collider position="0 -0.3 -1.5" rotation="-25 180 0" scale="5 5 5" rotation="-20 180 0">
        <a-entity id="gun" shooter click-to-shoot rotation="-15 180 0"></a-entity>
        <a-cursor color="white"></a-cursor>
      </a-entity>
      
      <a-entity id="leftHand" hand-tracking-grab-controls="hand: left;"></a-entity>
      <a-entity id="rightHand" hand-tracking-grab-controls="hand: right;"></a-entity>
    </a-camera>

    <a-entity gltf-model="#SkyBall" scale="50 50 50" rotation="0 90 0" ></a-entity>

  </a-scene>
</body>