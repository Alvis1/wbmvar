<html>
  <head>
    <script src="https://aframe.io/releases/1.7.1/aframe.min.js"></script>
    <!--Event-Set Component-->
    <script src="https://unpkg.com/aframe-event-set-component@5/dist/aframe-event-set-component.min.js"></script>

    <!--A-Frame Extras-->
    <script src="https://cdn.jsdelivr.net/gh/c-frame/aframe-extras@7.6.1/dist/aframe-extras.min.js"></script>
 
     <!--navigation component used in ImGame -->   
    <script src="components/a-cursor-navigation.js"></script>

    <script src="https://unpkg.com/aframe-super-hands-component@5.0.3/dist/aframe-super-hands-component.min.js"></script>

    <script>
      AFRAME.registerComponent('hide-on-bag-touch', {
        init: function () {
          this.el.addEventListener('obbcollisionstarted', (e) => {
            const otherEl = e.detail.withEl;
            if (otherEl && otherEl.id === 'bag') {
              this.el.setAttribute('visible', false);
            }
          });
        }
      });
    </script>

    <script>
      AFRAME.registerComponent('shake-on-bag-touch', {
        init: function () {

          // Initial position from HTML
          const pos = this.el.getAttribute('position');
          this.initialPosition = new THREE.Vector3(pos.x, pos.y, pos.z);

          this.isShaking = false;
          this.isTouchingBag = false;

          // Collision START
          this.el.addEventListener('obbcollisionstarted', (e) => {
            const otherEl = e.detail.withEl;
            if (!otherEl || otherEl.id !== 'bag') return;

            if (this.isTouchingBag || this.isShaking) return;

            this.isTouchingBag = true;
            this.isShaking = true;

            this.el.removeAttribute('animation__shake');
            this.el.setAttribute('animation__shake', {
              property: 'rotation',
              dur: 100,
              loop: 6,
              dir: 'alternate',
              easing: 'easeInOutSine',
              to: '0 0 10'
            });
          });

          // Collision END
          this.el.addEventListener('obbcollisionended', (e) => {
            const otherEl = e.detail.withEl;
            if (!otherEl || otherEl.id !== 'bag') return;
            this.isTouchingBag = false;
          });

          // Animation complete
          this.el.addEventListener('animationcomplete__shake', () => {
            // Only reset position if NOT grabbed
            if (!this.el.is('grabbed')) {
              this.el.setAttribute('rotation', '0 0 0');
              this.el.setAttribute('position', this.initialPosition);
            } else {
              // If grabbed, just reset rotation
              this.el.setAttribute('rotation', '0 0 0');
            }
            this.isShaking = false;
          });
        }
      });
      </script>





  </head>
  <body>
    
    <a-scene obb-collider="showColliders: false" cube-ui-manager>
      <!--Camera with cursor and hand tracking enabled. Pinch gesture as click event-->
      <a-entity 
        position="0 0 0" 
        id="cameraRig" 
        movement-controls="speed: 1.01; enabled:false"
        a-cursor-teleport="cameraRig: #cameraRig; cameraHead: #head">
        <a-entity id="head" position="0 1.6 0" camera="near: 0.1" look-controls="reverseMouseDrag: false; pointerLockEnabled: true">
          <a-cursor color="black" position="0 0 -0.7"></a-cursor>
        </a-entity>
        <a-entity id="leftHand" hand-tracking-grab-controls="hand: left"></a-entity>
        <a-entity id="rightHand" hand-tracking-grab-controls="hand: right"></a-entity>
      </a-entity>

      <!--Equirectangular Image env-->
      <a-assets>
        <img id="room_env" src="./img/room_env4.jpg">
      </a-assets>
      <a-sky src="#room_env"></a-sky>

      <!--Table-->
      <a-box id="table" color="white" position="-0.75 0.5 0" scale="0.7 1 1.5"></a-box>

      <!--Grabbing objects-->
      <a-box id="cube1" grabbable="hoverEnabled: true; hoverColor: #red;" position="-0.85 1.05 0.6" color="yellow" scale="0.05 0.05 0.05" rotation="0 0 0" obb-collider="objects: #bag" shake-on-bag-touch></a-box>
      <a-box id="cube2" grabbable=" hoverEnabled: true; hoverColor: #red;" position="-0.5 1.05 0" color="blue" scale="0.05 0.05 0.05" rotation="0 0 0" obb-collider="objects: #bag" hide-on-bag-touch></a-box>
      <a-box id="cube3" grabbable=" hoverEnabled: true; hoverColor: #red;" position="-0.7 1.05 0.2" color="black" scale="0.05 0.05 0.05" rotation="0 0 0" obb-collider="objects: #bag" hide-on-bag-touch></a-box>
      <a-box id="cube4" grabbable=" hoverEnabled: true; hoverColor: #red;" position="-0.6 1.05 -0.6" color="pink" scale="0.05 0.05 0.05" rotation="0 0 0" obb-collider="objects: #bag" shake-on-bag-touch></a-box>
      <a-box id="cube5" grabbable=" hoverEnabled: true; hoverColor: #red;" position="-0.45 1.05 -0.5" color="green" scale="0.05 0.05 0.05" rotation="0 0 0" obb-collider="objects: #bag" hide-on-bag-touch></a-box>

      <a-box id="bag" position="-0.51 1.1 0.6" color="grey" scale="0.2 0.2 0.2" obb-collider="centerModel: true"></a-box>

      <!-- <a-assets>
        <a-asset-item id="water" src="./src/water_bottle/water_bottle.obj"></a-asset-item>
        <a-asset-item id="water-mtl" src="./src/water_bottle/water_bottle.mtl"></a-asset-item>
      </a-assets> -->

      <!-- <a-entity obj-model="obj: #water; mtl: #water-mtl" position="-0.5 1.05 0"></a-entity> -->

      <a-entity id="cube-ui" position="0 1.8 -1.2">
        <a-plane width="0.6" height="0.5" color="#222" opacity="0.8"></a-plane>
          <a-text
            id="cube-ui-text"
            value="[ ] blue cube\n[ ] green cube \n[ ] black cube"
            color="white"
            width="1"
            align="left"
            position="-0.28 0.18 0.01">
          </a-text>
      </a-entity>
      

    </a-scene>
  </body>
</html>